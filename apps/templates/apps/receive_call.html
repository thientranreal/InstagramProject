<!-- videocall/receive_call.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Receive Call</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="{% static 'js/webrtc.js' %}"></script>
</head>
<body>
    <h1>Receive Call</h1>
    <video id="video-element" autoplay playsinline></video>
</body>
</html>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
     $(document).ready(function() {
    // Gửi yêu cầu gọi và nhận offer từ server
    $.ajax({
        url: '/send_offer/',
        type: 'GET',
        success: function(response) {
            var offer = response.offer;

            // Xử lý offer và tạo kết nối WebRTC
            createPeerConnection(offer);
        },
        error: function(error) {
            console.log(error);
        }
    });

    // Tạo kết nối WebRTC với offer nhận được
    function createPeerConnection(offer) {
        var pc = new RTCPeerConnection();
        
        pc.setRemoteDescription(new RTCSessionDescription(offer));

        // Xử lý sự kiện ICE candidate
        pc.onicecandidate = function(event) {
            if (event.candidate) {
                // Gửi ICE candidate đến đối phương
            }
        };

        // Xử lý sự kiện khi kết nối được thiết lập
        pc.ontrack = function(event) {
            // Hiển thị luồng video
            var videoElement = document.getElementById('video-element');
            videoElement.srcObject = event.streams[0];
        };

        // Tạo answer
        pc.createAnswer()
            .then(function(answer) {
                return pc.setLocalDescription(answer);
            })
            .then(function() {
                // Gửi answer đến người gọi
                sendAnswerToCaller(pc.localDescription);
            })
            .catch(function(error) {
                console.log(error);
            });
    }

    // Gửi answer đến người gọi qua WebSocket
    function sendAnswerToCaller(answer) {
        $.ajax({
            url: '/send_answer/',
            type: 'POST',
            data: {'answer': answer},
            success: function(response) {
                console.log('Answer sent to caller');
            },
            error: function(error) {
                console.log(error);
            }
        });
    }
});
    </script>
